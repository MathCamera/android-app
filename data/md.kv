#:import XCamera modules.xcamera.XCamera
#:import is_android modules.xcamera.xcamera.is_android
#:import Clipboard kivy.core.clipboard.Clipboard
#:import ClickableTextFieldRound modules.custom.textfield.ClickableTextFieldRound
#:import LeftLabel modules.custom.leftlabel.LeftLabel
#:import CustomFlatIconButton modules.custom.button.CustomFlatIconButton
#:import MultiModeFlatButton modules.custom.button.MultiModeFlatButton

#:include modules/keyboard/main_kb.kv
#:include modules/keyboard/letters_kb.kv
#:include modules/keyboard/functions_kb.kv
#:include modules/keyboard/top_kb.kv

<KeyboardFlatButton@MDFlatButton>:
    size_hint: 1, 1
    md_bg_color: (255,255,255,1)
    on_parent:
        self.font_size *= 2

<LetterFlatButton@MDFlatButton>:
    size_hint: 0.5,0.5
    md_bg_color: (255,255,255,1)
    on_parent:
        self.font_size *= 1.5

<CustomFlatIconButton>:
    size_hint: 1, 1
    md_bg_color: (255,255,255,1)

<MultiModeFlatButton>:
    text: self.modes[0]
    value: self.values[0]
    size_hint: 1, 1
    md_bg_color: (255,255,255,.4)
    on_parent:
        self.font_size *= 2

<DrawerClickableItem@MDNavigationDrawerItem>
    _no_ripple_effect: True
    focus_behavior: False

<DrawerLabelItem@MDNavigationDrawerItem>
    focus_behavior: False
    _no_ripple_effect: True

<Text_Field@MDTextField>:

<ClickableTextFieldRound>:
    #size_hint_y: None
    height: text_field.height

    Text_Field:
        id: text_field
        hint_text:"Введите уравнение"
        text: root.text
        helper_text: 'Это поле не должно быть пустым'
        helper_text_mode: "on_error"
        pos_hint:{"top":1}
        keyboard_mode:"managed"
        max_height: "140dp"

    MDIconButton:
        icon: "close-circle-outline"
        pos_hint: {"center_y": .5}
        pos: text_field.width - self.width + dp(8), 0
        theme_text_color: "Hint"
        on_release: text_field.text = ""
        pos_hint:{"top":1}

MDScreen:
    name:"main"
    MDNavigationLayout:
        MDTopAppBar:
            id:tb
            title: "Главная"
            elevation: 4
            pos_hint: {"top": 1}
            md_bg_color: app.config["main_color"]
            specific_text_color: "#ffffff"
            left_action_items: [["menu", lambda x: nav_drawer.set_state("open")]]
            right_action_items:[["history", lambda x: app.set_screen("sc_history","История"), "", "История"],["cog", lambda x: app.set_screen("sc_settings","Настройки"), "", "Настройки"]]

        ScreenManager:
            id:sm
            Screen:
                name:"sc_home"
                BoxLayout:
                    orientation:"vertical"
                    padding:[50,tb.height + dp(30),50,30]
                    spacing:30
                    center_y: root.center_y

                    MDLabel:
                        text: "Что вы хотите сделать?"
                        halign:"center"
                        font_style:"H6"
                        adaptive_height:True

                    MDRectangleFlatIconButton:
                        icon: "text-recognition"
                        pos_hint:{"center_x":.5}
                        text: "Сканировать"
                        theme_text_color: "Custom"
                        text_color: "white"
                        md_bg_color: app.config["main_color"]
                        theme_icon_color: "Custom"
                        icon_color: "white"
                        on_release:
                            app.set_screen("sc_photo","Сканировать")

                    MDRectangleFlatIconButton:
                        icon: "calculator"
                        pos_hint:{"center_x":.5}
                        text: "Калькулятор"
                        theme_text_color: "Custom"
                        text_color: "white"
                        md_bg_color: app.config["main_color"]
                        theme_icon_color: "Custom"
                        icon_color: "white"
                        on_release:
                            app.set_screen("sc_text","Калькулятор")

                    MDRectangleFlatIconButton:
                        icon: "file-image"
                        pos_hint:{"center_x":.5}
                        text: "Выбрать из галереи"
                        theme_text_color: "Custom"
                        text_color: "white"
                        md_bg_color: app.config["main_color"]
                        theme_icon_color: "Custom"
                        icon_color: "white"
                        on_release:app.choose()
                            #app.set_screen("sc_photo","Выбрать из галлереи")

            MDScreen:
                on_enter:app.handle_camera()
                name:"sc_photo"

                MDBoxLayout:
                    id:proxy
                    padding: [0,tb.height+dp(10),0,250]
                    orientation:"vertical"
                    XCamera:
                        id: xcamera
                        play: True
                        keep_ratio: True
                        on_picture_taken: app.picture_taken(*args)
                        center: self.size and proxy.center
                        size:
                            (proxy.height, proxy.width) if is_android() \
                            else (proxy.width, proxy.height)
                        canvas.before:
                            PushMatrix
                            Rotate:
                                angle: -90 if is_android() else 0
                                origin: self.center
                        canvas.after:
                            PopMatrix

                MDIconButton:
                    pos_hint: {"center_x":.2,"center_y":.1}
                    icon: "calculator"
                    icon_size: "30sp"
                    _no_ripple_effect: True
                    on_press:app.set_screen("sc_text","Калькулятор")

                MDIconButton:
                    _no_ripple_effect: True
                    pos_hint: {"center_x":.5,"center_y":.1}
                    icon: "camera-iris"
                    icon_color:"white"
                    icon_size: "30sp"
                    theme_icon_color: "Custom"
                    md_bg_color:"black"
                    on_press:
                        if app.check_camera_perm() == True:app.make_photo()
                        else: app.show_cam_alert_dialog()

                MDIconButton:
                    id:flashlight_btn
                    _no_ripple_effect: True
                    pos_hint: {"center_x":.8,"center_y":.1}
                    icon_size: "30sp"
                    icon: "flash"
                    on_press:app.switch_flashlight_mode()

            Screen:
                name:"sc_text"
                on_enter:
                    textarea.ids.text_field.focus=True
                    app.on_text_screen()

                MDBoxLayout:
                    padding:[0,tb.height + dp(15),0,0]
                    orientation:"vertical"
                    MDBoxLayout:
                        id:text_inp_bl
                        size_hint_y: 0.8
                        padding:[20,0,20,30]
                        orientation:"vertical"
                        #spacing:10

                        MDDropDownItem:
                            id: drop_item
                            pos_hint: {'center_x': .5, 'center_y': .5}
                            text: 'Выберите действие'
                            on_release: app.menu.open()
                        
                        ClickableTextFieldRound:
                            id:textarea

                        MDRectangleFlatIconButton:
                            id:send_btn
                            icon: "arrow-right"
                            text: "Показать решение"
                            pos_hint:{"center_x":.5}
                            theme_text_color: "Custom"
                            text_color: "white"
                            md_bg_color:app.config["main_color"]
                            theme_icon_color: "Custom"
                            icon_color: "white"
                            on_release:
                                app.send_equation(textarea.ids.text_field.text,app.solver_type)

                    TOP_KB:

                    MDBoxLayout:
                        orientation:"vertical"
                        ScreenManager:
                            id:kb_manager
                            MDScreen:
                                name:"main_kb"
                                MAIN_KB:

                            MDScreen:
                                name:"letters_kb"
                                LETTERS_KB:

                            MDScreen:
                                name:"functions_kb"
                                FUNCTIONS_KB:

            Screen:
                name:"sc_solve"

                GridLayout:
                    id:gl
                    cols:1
                    padding:[20,tb.height + dp(5),20,20]
                    spacing:10
                    
                    MDIconButton:
                        id:mcd_btn
                        icon: "arrow-left"
                        on_release:app.set_screen(app.prev_screen_data["sc_name"],app.prev_screen_data["sc_title"])
                        
                    MDCard:
                        id:mdc
                        orientation:"vertical"
                        size_hint_x: 1
                        pos_hint: {"top":1}
                        md_bg_color:"#039866"
                        padding:[30,15,30,15]
                        size_hint_y: None
                        height:(gl.height-mcd_btn.height)/2.5
                        spacing:10

                        LeftLabel:
                            id:equ_type_label
                            adaptive_size: True
                            bold:True
                            text:"Задача:"
                                    
                        LeftLabel:
                            adaptive_size: True
                            id:equation_label

                        LeftLabel:
                            adaptive_size: True
                            bold:True
                            text:"Ответ:"
                        
                        ScrollView:
                            do_scroll_x: False
                            do_scroll_y: True
                            size_hint_y:None
                            height:mdc.height/4

                            Label:
                                id:solution_label
                                size_hint_y: None
                                height: self.texture_size[1]
                                text_size: self.width, None

                        MDRectangleFlatIconButton:
                            icon: "content-copy"
                            text: "Скопировать ответ"
                            pos_hint:{"center_x":.5}
                            theme_text_color: "Custom"
                            text_color: "white"
                            md_bg_color:app.config["main_color"]
                            theme_icon_color: "Custom"
                            icon_color: "white"
                            on_release:Clipboard.copy(solution_label.text)

                    MDCard:
                        id:plot_card
                        orientation:"vertical"
                        pos_hint: {"top":1}
                        md_bg_color:"#039866"
                        padding:[30,15,30,15]
                        size_hint_y: None
                        height:(gl.height-mcd_btn.height)/2.5
                        spacing:10
                        visible:False
                        
                        size_hint_x: 1 if self.visible else 0
                        opacity: 1 if self.visible else 0
                        disabled: not self.visible

                        FitImage:
                            id:plot_img
                            #source: "sympy_tmp/image.png"
                            size_hint_y: .35
                            pos_hint: {"top": 1}
                            radius: 10, 10, 10, 10
                            visible: plot_card.visible
                            size_hint_x: 1 if plot_card.visible else 0
                            opacity: 1 if plot_card.visible else 0
                            disabled: not plot_card.visible

            Screen:
                name:"sc_history"
                on_enter:
                    app.load_history()

                BoxLayout:
                    orientation:"vertical"
                    padding:[15,tb.height + dp(15),15,30]

                    MDScrollView:
                        MDList:
                            id:history_sw

                    MDRectangleFlatIconButton:
                        icon: "broom"
                        text: "Очистить историю"
                        pos_hint:{"center_x":.5}
                        theme_text_color: "Custom"
                        text_color: "white"
                        md_bg_color:app.config["main_color"]
                        theme_icon_color: "Custom"
                        icon_color: "white"
                        on_release:app.clear_history()

            Screen:
                name:"sc_settings"
                on_enter:app.setup()
                BoxLayout:
                    orientation:"vertical"
                    padding:[50,tb.height + dp(30),50,30]
                    spacing:15
                    GridLayout:
                        cols:2
                        id:settings_grid

                        MDLabel:
                            text:"Тёмная тема\n"
                            adaptive_height:True

                        MDSwitch:
                            adaptive_width:True
                            id:dark_theme
                            on_active: app.handle_switch("dark_theme",self.active)

                        MDLabel:
                            text:"Вспышка\n"
                            adaptive_height:True

                        MDSwitch:
                            adaptive_width:True
                            id:enable_flashlight
                            on_active: app.handle_switch("enable_flashlight",self.active)

                        MDLabel:
                            text:"Авто вспышка\n"
                            adaptive_height:True

                        MDSwitch:
                            adaptive_width:True
                            id:auto_flashlight
                            on_active: app.handle_switch("auto_flashlight",self.active)

                        MDLabel:
                            text:"Режим отладки\n"
                            adaptive_height:True

                        MDSwitch:
                            adaptive_width:True
                            id:debug_mode
                            on_active: app.handle_switch("debug_mode",self.active)

                    MDRectangleFlatIconButton:
                        icon: "broom"
                        text: "Очистить кеш"
                        #pos_hint:{"center_x":.5}
                        theme_text_color: "Custom"
                        text_color: "white"
                        md_bg_color:app.config["main_color"]
                        theme_icon_color: "Custom"
                        icon_color: "white"
                        on_release:app.clear_cache()

                    MDRectangleFlatIconButton:
                        icon: "content-copy"
                        text: "Скопировать логи"
                        #pos_hint:{"center_x":.5}
                        theme_text_color: "Custom"
                        text_color: "white"
                        md_bg_color:app.config["main_color"]
                        theme_icon_color: "Custom"
                        icon_color: "white"
                        on_release:Clipboard.copy(app.get_logs())

        MDNavigationDrawer:
            id: nav_drawer
            radius: (0, 16, 16, 0)

            MDNavigationDrawerMenu:
                MDNavigationDrawerHeader:
                    title: "Math Camera"
                    source: "media/transparent-icon.png"
                    spacing:"4dp"
                    padding: "12dp", 0, 0, "28dp"

                MDNavigationDrawerDivider:

                DrawerClickableItem:
                    icon: "text-recognition"
                    text: "Сканировать"
                    on_release:
                        app.set_screen('sc_photo',"Сканировать")

                DrawerClickableItem:
                    icon: "calculator"
                    text: "Калькулятор"
                    on_release:
                        app.set_screen('sc_text',"Калькулятор")

                DrawerClickableItem:
                    icon: "file-image"
                    text: "Выбрать из галереи"
                    on_release:app.choose()

                DrawerClickableItem:
                    icon: "history"
                    text: "История"
                    on_release:app.set_screen('sc_history',"История")

                MDNavigationDrawerDivider:

                DrawerClickableItem:
                    icon: "cog"
                    text: "Настройки"
                    on_release:
                        app.set_screen('sc_settings',"Настройки")

                DrawerClickableItem:
                    icon: "information-outline"
                    text: "О нас"
                    on_release:
                        app.open_browser("https://mathcamera.page.link/website")

                MDNavigationDrawerDivider:

                DrawerLabelItem:
                    icon: "information-outline"
                    text: "Math Camera v"+app.config["current_version"]
