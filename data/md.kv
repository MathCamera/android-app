#:import XCamera modules.xcamera.XCamera
#:import is_android modules.xcamera.xcamera.is_android
#:import Clipboard kivy.core.clipboard.Clipboard
#:import ClickableTextFieldRound modules.custom.textfield.ClickableTextFieldRound
#:import CustomFlatIconButton modules.custom.button.CustomFlatIconButton
#:import MultiModeFlatButton modules.custom.button.MultiModeFlatButton

#:include modules/keyboard/main_kb.kv
#:include modules/keyboard/letters_kb.kv
#:include modules/keyboard/functions_kb.kv
#:include modules/keyboard/top_kb.kv

<KeyboardFlatButton@MDFlatButton>:
    size_hint: 1, 1
    md_bg_color:app.theme_cls.bg_light
    on_parent:
        self.font_size *= 2
    ripple_duration_in_fast: .1

<LetterFlatButton@MDFlatButton>:
    size_hint: 0.5,0.5
    md_bg_color:app.theme_cls.bg_light
    on_parent:
        self.font_size *= 1.5
    ripple_duration_in_fast: .1

<CustomFlatIconButton>:
    size_hint: 1, 1
    md_bg_color:app.theme_cls.bg_light
    ripple_duration_in_fast: .1

<MultiModeFlatButton>:
    text: self.modes[0]
    value: self.values[0]
    size_hint: 1, 1
    md_bg_color:app.theme_cls.divider_color
    on_parent:
        self.font_size *= 2
    ripple_duration_in_fast: .1

<DrawerClickableItem@MDNavigationDrawerItem>
    _no_ripple_effect: True
    focus_behavior: False
    selected_color:app.theme_cls.text_color #"#DCDCDC" if app.theme_cls.theme_style == "Dark" else "#101010"
    icon_color:app.theme_cls.text_color
    text_color:app.theme_cls.text_color

<ClickableTextFieldRound>:
    #size_hint_y: None
    height: text_field.height

    MDTextField:
        id: text_field
        hint_text:"Введите уравнение"
        text: root.text
        helper_text: 'Это поле не должно быть пустым'
        helper_text_mode: "on_error"
        pos_hint:{"top":1}
        keyboard_mode:"managed"
        max_height: "140dp"
        color:app.theme_cls.error_color
        use_bubble: False

    MDIconButton:
        icon: "close-circle-outline"
        pos_hint: {"center_y": .5}
        pos: text_field.width - self.width + dp(8), 0
        theme_text_color: "Hint"
        on_release: text_field.text = ""
        pos_hint:{"top":1}

ScreenManager:
    id:root_sm
    MDScreen:
        name:"main_sc"
        MDNavigationLayout:
            MDTopAppBar:
                id:tb
                title:"Главная"
                pos_hint: {"top": 1}
                md_bg_color: app.main_colors[0]
                left_action_items: [["menu", lambda x: nav_drawer.set_state("open")]]
                right_action_items:[["history", lambda x: app.set_screen("sc_history"), "", "История"],["cog", lambda x: app.set_screen("sc_settings"), "", "Настройки"]]

            ScreenManager:
                id:sm

                MDScreen:
                    name:"sc_home"
                    BoxLayout:
                        orientation:"vertical"
                        padding:[50,tb.height + dp(30),50,30]
                        spacing:30
                        center_y: root.center_y

                        MDLabel:
                            text: "Что вы хотите сделать?"
                            halign:"center"
                            font_style:"H6"
                            adaptive_height:True

                        MDRectangleFlatIconButton:
                            icon: "text-recognition"
                            pos_hint:{"center_x":.5}
                            text: "Сканировать"
                            theme_text_color: "Custom"
                            text_color: "white"
                            md_bg_color: app.main_colors[0]
                            theme_icon_color: "Custom"
                            icon_color: "white"
                            on_release:
                                app.set_screen("sc_photo")

                        MDRectangleFlatIconButton:
                            icon: "calculator"
                            pos_hint:{"center_x":.5}
                            text: "Калькулятор"
                            theme_text_color: "Custom"
                            text_color: "white"
                            md_bg_color: app.main_colors[0]
                            theme_icon_color: "Custom"
                            icon_color: "white"
                            on_release:
                                app.set_screen("sc_text")

                        MDRectangleFlatIconButton:
                            icon: "file-image"
                            pos_hint:{"center_x":.5}
                            text: "Выбрать из галереи"
                            theme_text_color: "Custom"
                            text_color: "white"
                            md_bg_color: app.main_colors[0]
                            theme_icon_color: "Custom"
                            icon_color: "white"
                            on_release:app.choose()

                MDScreen:
                    name:"sc_photo"
                    on_enter:
                        app.handle_camera()
                        tb.title="Сканировать"

                    MDBoxLayout:
                        id:proxy
                        padding: [0,tb.height+dp(10),0,250]
                        orientation:"vertical"
                        XCamera:
                            id: xcamera
                            play: True
                            keep_ratio: True
                            on_picture_taken: app.picture_taken(*args)
                            center: self.size and proxy.center
                            size:
                                (proxy.height, proxy.width) if is_android() \
                                else (proxy.width, proxy.height)
                            canvas.before:
                                PushMatrix
                                Rotate:
                                    angle: -90 if is_android() else 0
                                    origin: self.center
                            canvas.after:
                                PopMatrix

                    MDIconButton:
                        pos_hint: {"center_x":.2,"center_y":.1}
                        icon: "calculator"
                        icon_size: "30sp"
                        _no_ripple_effect: True
                        on_press:app.set_screen("sc_text")

                    MDIconButton:
                        _no_ripple_effect: True
                        pos_hint: {"center_x":.5,"center_y":.1}
                        icon: "camera-iris"
                        icon_color:"white"
                        icon_size: "30sp"
                        theme_icon_color: "Custom"
                        md_bg_color:"black"
                        on_press:
                            if app.check_camera_perm() == True:app.make_photo()
                            else: app.show_cam_alert_dialog()

                    MDIconButton:
                        id:flashlight_btn
                        _no_ripple_effect: True
                        pos_hint: {"center_x":.8,"center_y":.1}
                        icon_size: "30sp"
                        icon: "flash"
                        on_press:app.switch_flashlight_mode()

                Screen:
                    name:"sc_text"
                    on_enter:
                        tb.title="Калькулятор"
                        textarea.ids.text_field.focus=True
                        textarea.ids.text_field.error=False
                        app.on_text_screen()

                    MDBoxLayout:
                        padding:[0,tb.height + dp(15),0,0]
                        orientation:"vertical"
                        MDBoxLayout:
                            id:text_inp_bl
                            size_hint_y: 0.8
                            padding:[20,0,20,30]
                            orientation:"vertical"
                            #spacing:10

                            MDDropDownItem:
                                id: drop_item
                                pos_hint: {'center_x': .5, 'center_y': .5}
                                text: 'Выберите действие'
                                on_release: app.menu.open()
                            
                            
                            ClickableTextFieldRound:
                                id:textarea

                            MDRectangleFlatIconButton:
                                id:send_btn
                                icon: "arrow-right"
                                text: "Показать решение"
                                pos_hint:{"center_x":.5}
                                theme_text_color: "Custom"
                                text_color: "white"
                                md_bg_color:app.main_colors[0]
                                theme_icon_color: "Custom"
                                icon_color: "white"
                                on_release:
                                    app.send_equation(textarea.ids.text_field.text,app.solver_type)

                        TOP_KB:

                        MDBoxLayout:
                            orientation:"vertical"
                            ScreenManager:
                                id:kb_manager
                                MDScreen:
                                    name:"main_kb"
                                    MAIN_KB:

                                MDScreen:
                                    name:"letters_kb"
                                    LETTERS_KB:

                                MDScreen:
                                    name:"functions_kb"
                                    FUNCTIONS_KB:

                Screen:
                    on_enter:
                        tb.title="Решение"
                    name:"sc_solve"
                    BoxLayout:
                        id:gl
                        orientation:"vertical"
                        padding:[20,tb.height + dp(5),20,20]
                        MDIconButton:
                            id:mcd_btn
                            icon: "arrow-left"
                            on_release:app.set_screen(app.last_screen)

                        ScrollView:
                            id:gl_sw
                            do_scroll_x: False
                            do_scroll_y: False
                            
                            GridLayout:
                                cols:1
                                spacing:10
                                size_hint_y: None
                                height: self.minimum_height
                                    
                                MDCard:
                                    id:mdc
                                    orientation:"vertical"
                                    size_hint_x: 1
                                    pos_hint: {"top":1}
                                    md_bg_color:app.main_colors[1]
                                    padding:[30,15,30,15]
                                    size_hint_y: None
                                    height:(gl.height-mcd_btn.height)/2.5
                                    spacing:10

                                    MDLabel:
                                        id:equ_type_label
                                        bold:True
                                        text:"Задача:"
                                        adaptive_size:True
                                        theme_text_color: "Custom"
                                        text_color: "white"
                                                
                                    MDLabel:
                                        adaptive_size: True
                                        id:equation_label
                                        theme_text_color: "Custom"
                                        text_color: "white"

                                    MDLabel:
                                        adaptive_size: True
                                        bold:True
                                        text:"Ответ:"
                                        theme_text_color: "Custom"
                                        text_color: "white"
                                    
                                    ScrollView:
                                        do_scroll_x: False
                                        do_scroll_y: True
                                        size_hint_y:None
                                        height:mdc.height/4

                                        Label:
                                            id:solution_label
                                            size_hint_y: None
                                            height: self.texture_size[1]
                                            text_size: self.width, None

                                    MDRectangleFlatIconButton:
                                        icon: "content-copy"
                                        text: "Скопировать ответ"
                                        pos_hint:{"center_x":.5}
                                        theme_text_color: "Custom"
                                        text_color: "white"
                                        md_bg_color:app.main_colors[0]
                                        theme_icon_color: "Custom"
                                        icon_color: "white"
                                        on_release:Clipboard.copy(solution_label.text)

                                MDCard:
                                    id:plot_card
                                    orientation:"vertical"
                                    pos_hint: {"top":1}
                                    md_bg_color:app.main_colors[1]
                                    padding:[30,15,30,15] #25
                                    size_hint_y: None
                                    height:(gl.height-mcd_btn.height)/1.5
                                    spacing:15
                                    visible:False
                                    
                                    size_hint_x: 1 if self.visible else 0
                                    opacity: 1 if self.visible else 0
                                    disabled: not self.visible

                                    MDLabel:
                                        text:"График"
                                        adaptive_size:True
                                        theme_text_color: "Custom"
                                        text_color: "white"
                                        font_style:"H6"

                                    FitImage:
                                        id:plot_img
                                        #source: "sympy_tmp/image.png"
                                        size_hint: .35,.35
                                        pos_hint: {"top": 1}
                                        #radius: 10, 10, 10, 10
                                        visible: plot_card.visible
                                        size_hint_x: 1 if plot_card.visible else 0
                                        opacity: 1 if plot_card.visible else 0
                                        disabled: not plot_card.visible

                                    MDRectangleFlatIconButton:
                                        icon: "arrow-right"
                                        text: "Просмотр графика"
                                        pos_hint:{"center_x":.5}
                                        theme_text_color: "Custom"
                                        text_color: "white"
                                        md_bg_color:app.main_colors[0]
                                        theme_icon_color: "Custom"
                                        icon_color: "white"
                                        on_release:
                                            if sc_imgview_img.source == None:sc_imgview_img.size=[sc_imgview_img.size[0]*6,sc_imgview_img.size[1]*6]
                                            sc_imgview_img.source = plot_img.source
                                            app.set_screen("sc_imgview")

                Screen:
                    name:"sc_history"
                    on_enter:
                        tb.title='История'
                        app.load_history()

                    BoxLayout:
                        orientation:"vertical"
                        padding:[15,tb.height + dp(5),15,30]

                        MDScrollView:
                            MDList:
                                id:history_sw

                        MDRectangleFlatIconButton:
                            icon: "broom"
                            text: "Очистить историю"
                            pos_hint:{"center_x":.5}
                            theme_text_color: "Custom"
                            text_color: "white"
                            md_bg_color:app.main_colors[0]
                            theme_icon_color: "Custom"
                            icon_color: "white"
                            on_release:app.clear_history()

                Screen:
                    name:"sc_imgview"
                    on_enter:
                        tb.title='Просмотр графика'

                    BoxLayout:
                        orientation:"vertical"
                        padding:[15,tb.height + dp(15),15,30]
                        MDIconButton:
                            id:mcd_btn
                            icon: "arrow-left"
                            on_release:app.set_screen(app.last_screen)

                        ScrollView:
                            do_scroll_x:True
                            do_scroll_y:True
                            FitImage:
                                id:sc_imgview_img
                                #size:[self.size[0]*2,self.size[1]*2]
                                #size:[sc_imgview_img.size[0]*2,sc_imgview_img.size[1]*2]
                                size_hint:None,None
                                keep_ratio:True

                Screen:
                    name:"sc_settings"
                    on_enter:
                        tb.title="Насторйки"
                        app.setup()

                    BoxLayout:
                        orientation:"vertical"
                        padding:[50,tb.height + dp(30),50,30]
                        spacing:15
                        GridLayout:
                            cols:2
                            id:settings_grid

                            MDLabel:
                                text:"Тёмная тема\n"
                                adaptive_height:True

                            MDSwitch:
                                adaptive_width:True
                                id:dark_theme
                                on_active: app.handle_switch("dark_theme",self.active)

                            MDLabel:
                                text:"Вспышка\n"
                                adaptive_height:True

                            MDSwitch:
                                adaptive_width:True
                                id:enable_flashlight
                                on_active: app.handle_switch("enable_flashlight",self.active)

                            MDLabel:
                                text:"Авто вспышка\n"
                                adaptive_height:True

                            MDSwitch:
                                adaptive_width:True
                                id:auto_flashlight
                                on_active: app.handle_switch("auto_flashlight",self.active)

                            MDLabel:
                                text:"Режим отладки\n"
                                adaptive_height:True

                            MDSwitch:
                                adaptive_width:True
                                id:debug_mode
                                on_active: app.handle_switch("debug_mode",self.active)

                        MDRectangleFlatIconButton:
                            icon: "broom"
                            text: "Очистить кеш"
                            theme_text_color: "Custom"
                            text_color: "white"
                            md_bg_color:app.main_colors[0]
                            theme_icon_color: "Custom"
                            icon_color: "white"
                            on_release:app.clear_cache()

                        MDRectangleFlatIconButton:
                            icon: "content-copy"
                            text: "Скопировать логи"
                            theme_text_color: "Custom"
                            text_color: "white"
                            md_bg_color:app.main_colors[0]
                            theme_icon_color: "Custom"
                            icon_color: "white"
                            #on_release:app.set_screen('sc_logs')
                            on_release:Clipboard.copy(app.get_logs())

            MDNavigationDrawer:
                id: nav_drawer
                radius: (0, 16, 16, 0)

                MDNavigationDrawerMenu:
                    MDNavigationDrawerHeader:
                        title: "Math Camera"
                        source: "media/transparent-icon.png"
                        spacing:"4dp"
                        padding: "12dp", 0, 0, "28dp"

                    MDNavigationDrawerDivider:

                    DrawerClickableItem:
                        icon: "text-recognition"
                        text: "Сканировать"
                        on_release:
                            app.set_screen('sc_photo')

                    DrawerClickableItem:
                        icon: "calculator"
                        text: "Калькулятор"
                        on_release:
                            app.set_screen('sc_text')

                    DrawerClickableItem:
                        icon: "file-image"
                        text: "Выбрать из галереи"
                        on_release:app.choose()

                    DrawerClickableItem:
                        icon: "history"
                        text: "История"
                        on_release:app.set_screen('sc_history')

                    MDNavigationDrawerDivider:

                    DrawerClickableItem:
                        icon: "cog"
                        text: "Настройки"
                        on_release:
                            app.set_screen('sc_settings')

                    DrawerClickableItem:
                        icon: "information-outline"
                        text: "О нас"
                        on_release:
                            app.open_browser("https://mathcamera.page.link/website")

                    MDNavigationDrawerDivider:

                    DrawerClickableItem:
                        id:version_label
                        icon: "information-outline"
                        #text: "Math Camera v"+app.config_["current_version"]
    
    MDScreen:
        name:"update_sc"
        #on_enter:
        #    app.download_content()

        MDBoxLayout:
            padding:[30,100,30,200]
            orientation:"vertical"
            MDLabel:
                halign:"center"
                text:"Загрузка"
                font_style:"H4"

            MDLabel:
                id:update_version
                halign:"center"
                #text:"Обновление до версии "
                font_style:"H5"

            MDLabel:
                id:update_percent
                halign:"center"
                text:"0%"
                font_style:"H3"
                pos_hint_y:None

            MDProgressBar:
                id:update_progress
                size_hint_y:None
                height:10
                #type: "indeterminate"
                color:app.main_colors[1]